name: Test Nim bindings

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install llvm-mingw dependency (Windows)
        run: |
          mkdir -p external
          MINGW_BASE="https://github.com/mstorsjo/llvm-mingw/releases/download/20230905"
          MINGW_URL="$MINGW_BASE/llvm-mingw-20230905-ucrt-x86_64.zip"
          curl -L "$MINGW_URL" -o "external/mingw-amd64.zip"
          7z x -y "external/mingw-amd64.zip" -oexternal/mingw-amd64/
          mv external/mingw-amd64/**/* ./external/mingw-amd64

      - name: Install DLLs dependencies (Windows)
        run: |
          mkdir -p external
          curl -L "https://nim-lang.org/download/windeps.zip" -o external/windeps.zip
          7z x -y external/windeps.zip -oexternal/dlls-amd64

      - name: Run compile script
        run: ./scripts/compile.sh nim
        shell: bash

      - name: Setup Nim
        uses: jiro4989/setup-nim-action@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          nim-version: 'stable'
      
      - name: Install Nimble dependencies
        working-directory: bindings/nim/nim_code
        run: nimble install -Y

      - name: Test Nim project
        working-directory: bindings/nim/nim_code
        run: nimble test -Y
